<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hazardous Materials Register</title>
  <style>
    body { font-family: "Segoe UI Variable", "Segoe UI", system-ui, sans-serif; margin: 24px; background: #f6f8fb; color: #1f2a3d; }
    h2 { margin-bottom: 8px; }
    .banner {
      background: #fff3cd; color: #856404; border: 1px solid #ffeeba;
      padding: 14px 16px; border-radius: 8px; font-weight: 600; margin-bottom: 18px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .controls { margin: 12px 0 16px; }
    label { font-weight: 600; }
    input[type="text"]{
      width: min(820px, 100%); padding: 11px 12px; border: 1px solid #cbd5e1;
      border-radius: 10px; font-size: 14px; background: #fff;
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.04);
    }
    table { border-collapse: collapse; width: 100%; max-width: 1400px; background: #fff; border-radius: 10px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
    th, td { border: 1px solid #e6e6e6; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #f2f4f8; position: sticky; top: 0; z-index: 1; font-size: 13px; }
    td { font-size: 13px; }
    .muted { color: #667085; font-size: 12px; margin-top: 8px; }
    .count { margin: 10px 0; font-size: 13px; color: #333; }
    .view-btn {
      padding: 8px 10px; background: #0b61d6; color: #fff; border: none;
      border-radius: 7px; cursor: pointer; font-size: 13px; box-shadow: 0 1px 2px rgba(0,0,0,0.12);
    }
    .view-btn:hover { background: #084ea8; }
    .viewer { position: fixed; inset: 0; display: flex; align-items: center; justify-content: center; z-index: 10; }
    .viewer.hidden { display: none; }
    .viewer-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.45); }
    .viewer-dialog {
      position: relative; background: #fff; border-radius: 12px; box-shadow: 0 12px 38px rgba(0,0,0,0.22);
      width: min(1100px, 96%); height: min(92vh, 900px); display: flex; flex-direction: column; overflow: hidden;
    }
    .viewer-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 14px; background: #f7f7f7; border-bottom: 1px solid #e6e6e6; }
    .close-btn { background: transparent; border: 1px solid #cbd5e1; border-radius: 6px; padding: 6px 10px; cursor: pointer; font-weight: 600; }
    .viewer iframe { flex: 1; width: 100%; border: none; background: #fafafa; }
  </style>
</head>
<body>
  <h2>Hazardous Materials Register</h2>

  <div class="banner">
    WARNING: This table contains information about hazardous materials that may pose serious risks to human health.
    Data is provided for informational and compliance purposes only. Always follow official safety guidance and applicable regulations.
  </div>

  <div class="controls">
    <label for="search"><strong>Search hazardous materials</strong></label><br />
    <input id="search" type="text" placeholder="Search by code, name, hazard class, health effects, regulation..." autocomplete="off" />
    <div class="muted">Tip: search is case-insensitive and matches across all columns.</div>
  </div>

  <div class="count" id="count"></div>

  <table id="hazmatTable">
    <thead>
      <tr>
        {% for col in columns %}
          <th>{{ col.label }}</th>
        {% endfor %}
        <th>SDS PDF</th>
      </tr>
    </thead>
    <tbody>
      {% for row in rows %}
        <tr data-pdf="{{ row[pdf_field] }}">
          {% for col in columns %}
            <td>{{ row[col.key] }}</td>
          {% endfor %}
          <td>
            {% if row[pdf_field] %}
              <button class="view-btn" data-pdf="{{ row[pdf_field] }}">View PDF</button>
            {% else %}
              <span class="muted">Missing</span>
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="viewer hidden" id="viewer">
    <div class="viewer-backdrop" id="viewerBackdrop"></div>
    <div class="viewer-dialog">
      <div class="viewer-header">
        <div id="viewerTitle">SDS PDF</div>
        <button id="viewerClose" class="close-btn" aria-label="Close viewer">Close</button>
      </div>
      <iframe id="viewerFrame" title="SDS PDF" src="" allowfullscreen></iframe>
    </div>
  </div>

<script>
(function(){
  const input = document.getElementById("search");
  const table = document.getElementById("hazmatTable");
  const tbody = table.tBodies[0];
  const rows = Array.from(tbody.rows);
  const countEl = document.getElementById("count");
  const viewer = document.getElementById("viewer");
  const viewerFrame = document.getElementById("viewerFrame");
  const viewerTitle = document.getElementById("viewerTitle");

  function normalize(s){
    return (s || "").toString().toLowerCase();
  }

  function updateCount(visible){
    countEl.textContent = `Showing ${visible} of ${rows.length} materials`;
  }

  function filter(){
    const q = normalize(input.value).trim();
    let visible = 0;

    for (const r of rows){
      const text = normalize(r.innerText);
      const show = !q || text.includes(q);
      r.style.display = show ? "" : "none";
      if (show) visible++;
    }
    updateCount(visible);
  }

  function buildPdfUrl(relPath){
    if (!relPath) return "";
    return "/pdf/" + relPath.split("/").map(encodeURIComponent).join("/");
  }

  function openViewer(relPath, titleText){
    const url = buildPdfUrl(relPath);
    if (!url) return;
    viewerFrame.src = url;
    viewerTitle.textContent = titleText || "SDS PDF";
    viewer.classList.remove("hidden");
  }

  function closeViewer(){
    viewerFrame.src = "";
    viewer.classList.add("hidden");
  }

  table.addEventListener("click", (event) => {
    const btn = event.target.closest(".view-btn");
    if (!btn) return;
    const row = btn.closest("tr");
    const relPath = btn.getAttribute("data-pdf");
    const titleText = row ? row.cells[0].innerText : "";
    openViewer(relPath, titleText);
  });

  document.getElementById("viewerClose").addEventListener("click", closeViewer);
  document.getElementById("viewerBackdrop").addEventListener("click", closeViewer);
  document.addEventListener("keydown", (event) => {
    if (event.key === "Escape") closeViewer();
  });

  input.addEventListener("input", filter);
  filter(); // initial count
})();
</script>

</body>
</html>
